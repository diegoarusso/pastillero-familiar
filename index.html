<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pastillero Pro (Cloud)</title>
    <meta name="theme-color" content="#ffffff">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; user-select: none; background-color: #f9fafb; font-family: system-ui, -apple-system, sans-serif; overscroll-behavior-y: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        input, select, textarea { font-size: 16px !important; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #2563eb; border-radius: 50%; animation: spin 1s linear infinite; }
        #loader { position: fixed; inset: 0; background: white; z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .day-btn.selected { background-color: #2563eb; color: white; border-color: #2563eb; }
        .sync-badge { position: absolute; top: 12px; right: 12px; width: 8px; height: 8px; background-color: #22c55e; border-radius: 50%; z-index: 60; transition: all 0.3s; opacity: 0; }
        .sync-active { opacity: 1; animation: pulse 1s infinite; background-color: #eab308; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
    </style>
</head>
<body class="text-gray-800 h-screen overflow-hidden flex flex-col">

    <div id="loader"><div class="spinner mb-4"></div><p class="text-gray-500 text-sm font-medium">Cargando...</p></div>
    <div id="sync-status" class="sync-badge"></div>
    <div id="header-container"></div>
    <div id="main-container" class="flex-1 overflow-y-auto bg-gray-50 relative overscroll-contain">
        <div id="app-content" class="p-4 pb-28 max-w-md mx-auto min-h-full"></div>
    </div>
    <div id="nav-container" class="bg-white border-t border-gray-100 pb-safe sticky bottom-0 z-20 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]"></div>
    <div id="modal-container"></div>

    <script>
        const SUPABASE_URL = 'https://yprepyqpjubwlwlaylac.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlwcmVweXFwanVid2x3bGF5bGFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwMDEyODcsImV4cCI6MjA3OTU3NzI4N30.fZILFUCwf8Ckhm8TKfGEVI0aK0j4HQ1Kzhdwxf1tN_o';
        const { createClient } = supabase;
        const _db = createClient(SUPABASE_URL, SUPABASE_KEY);

        const I = {
            Pill: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m10.5 20.5 10-10a4.95 4.95 0 1 0-7-7l-10 10a4.95 4.95 0 1 0 7 7Z"/><path d="m8.5 8.5 7 7"/></svg>',
            Clock: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
            Check: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>',
            Plus: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
            Trash: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>',
            Edit: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>',
            Home: '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
            History: '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
            Stock: '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>',
            X: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
            Alert: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',
            Bell: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>',
            Calendar: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
            Zap: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>'
        };

        const store = {
            profiles: [
                { id: 1, name: 'Diego', color: 'bg-indigo-500', text: 'text-indigo-600', light: 'bg-indigo-50' },
                { id: 2, name: 'Emi', color: 'bg-rose-500', text: 'text-rose-600', light: 'bg-rose-50' },
                { id: 3, name: 'Santi', color: 'bg-emerald-500', text: 'text-emerald-600', light: 'bg-emerald-50' }
            ],
            currentProfile: 1,
            view: 'home',
            modal: false,
            modalType: 'regular',
            editId: null,
            meds: [],
            logs: [],
            form: { 
                name: '', dose: '', time: '08:00', trackStock: false, stock: '', minStock: '5',
                frequencyType: 'daily', frequencyDays: [], intervalDays: '', startDate: ''
            }
        };

        function setBusy(isBusy) {
            const badge = document.getElementById('sync-status');
            if(isBusy) badge.classList.add('sync-active');
            else badge.classList.remove('sync-active');
        }

        async function init() {
            try {
                const { data: dbMeds } = await _db.from('medications').select('*');
                const { data: dbLogs } = await _db.from('logs').select('*');
                store.meds = dbMeds || [];
                store.logs = dbLogs || [];
                render();
                const loader = document.getElementById('loader');
                loader.style.opacity = '0';
                setTimeout(() => loader.style.display = 'none', 300);
            } catch(e) { console.error(e); alert("Error de conexi√≥n"); }
        }

        function isScheduledForToday(med) {
            if (med.track_stock && (med.stock === null || med.stock <= 0)) return false;
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            if (!med.frequency_type || med.frequency_type === 'daily') return true;
            if (med.frequency_type === 'specific_days') {
                if (!med.frequency_days) return false;
                const dayOfWeek = today.getDay();
                return med.frequency_days.includes(dayOfWeek.toString());
            }
            if (med.frequency_type === 'interval') {
                if (!med.start_date || !med.interval_days) return false;
                const start = new Date(med.start_date);
                const current = new Date(todayStr);
                const diffTime = current - start;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                if (diffDays < 0) return false;
                return (diffDays % med.interval_days) === 0;
            }
            return true;
        }

        const Actions = {
            setProfile: (id) => { store.currentProfile = id; render(); },
            setView: (v) => { store.view = v; render(); },
            
            toggleTaken: async (medId) => {
                setBusy(true);
                const med = store.meds.find(m => m.id === medId);
                const today = new Date().toISOString().split('T')[0];
                const nowTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const existingLog = store.logs.find(l => l.med_id === medId && l.date === today && l.time === med.time);

                try {
                    if (existingLog) {
                        await _db.from('logs').delete().eq('id', existingLog.id);
                        let newStock = med.stock;
                        if(med.track_stock) {
                            newStock = (med.stock || 0) + 1;
                            await _db.from('medications').update({ stock: newStock }).eq('id', medId);
                        }
                        store.logs = store.logs.filter(l => l.id !== existingLog.id);
                        med.stock = newStock;
                    } else {
                        const newLog = { med_id: med.id, profile_id: store.currentProfile, date: today, time: med.time, taken_at: nowTime, name: med.name, dose: med.dose };
                        const { data, error } = await _db.from('logs').insert(newLog).select();
                        if(error) throw error;
                        let newStock = med.stock;
                        if(med.track_stock) {
                            newStock = Math.max(0, (med.stock || 0) - 1);
                            await _db.from('medications').update({ stock: newStock }).eq('id', medId);
                        }
                        store.logs.push(data[0]);
                        med.stock = newStock;
                    }
                } catch(e) { console.error(e); } finally { setBusy(false); render(); }
            },

            // ELIMINAR LOG DE HISTORIAL (Y DEVOLVER STOCK SI CORRESPONDE)
            deleteLog: async (logId) => {
                if(!confirm('¬øEliminar este registro?')) return;
                setBusy(true);
                
                const log = store.logs.find(l => l.id === logId);
                
                try {
                    // 1. Borrar de la DB
                    await _db.from('logs').delete().eq('id', logId);
                    
                    // 2. Si es regular y ten√≠a control de stock, devolver la pastilla
                    if (log.med_id) {
                        const med = store.meds.find(m => m.id === log.med_id);
                        if (med && med.track_stock) {
                            const newStock = (med.stock || 0) + 1;
                            await _db.from('medications').update({ stock: newStock }).eq('id', med.id);
                            med.stock = newStock; // Actualizar local
                        }
                    }

                    // 3. Actualizar lista local
                    store.logs = store.logs.filter(l => l.id !== logId);

                } catch(e) { console.error(e); alert("Error borrando historial"); } finally { setBusy(false); render(); }
            },

            updateStock: async (id, amount) => {
                setBusy(true);
                const med = store.meds.find(m => m.id === id);
                const newStock = Math.max(0, (med.stock || 0) + amount);
                med.stock = newStock;
                render();
                await _db.from('medications').update({ stock: newStock }).eq('id', id);
                setBusy(false);
            },

            saveForm: async () => {
                if(!store.form.name) return;
                setBusy(true);
                const medData = {
                    profile_id: store.currentProfile,
                    name: store.form.name, dose: store.form.dose, time: store.form.time,
                    track_stock: store.form.trackStock,
                    stock: store.form.trackStock ? parseInt(store.form.stock) : null,
                    min_stock: store.form.trackStock ? parseInt(store.form.minStock) : 5,
                    frequency_type: store.form.frequencyType,
                    frequency_days: store.form.frequencyType === 'specific_days' ? store.form.frequencyDays.join(',') : null,
                    interval_days: store.form.frequencyType === 'interval' ? parseInt(store.form.intervalDays) : null,
                    start_date: store.form.frequencyType === 'interval' ? store.form.startDate : null
                };
                try {
                    if(store.editId) {
                        const { data } = await _db.from('medications').update(medData).eq('id', store.editId).select();
                        store.meds = store.meds.map(m => m.id === store.editId ? data[0] : m);
                    } else {
                        const { data } = await _db.from('medications').insert(medData).select();
                        store.meds.push(data[0]);
                    }
                    store.modal = false;
                } catch(e) { console.error(e); alert("Error guardando"); } finally { setBusy(false); render(); }
            },

            // GUARDAR OCASIONAL (Con hora custom)
            saveOccasional: async () => {
                if(!store.form.name) return;
                setBusy(true);
                const now = new Date();
                const time = store.form.time; // Usamos la hora del input
                
                const logData = {
                    profile_id: store.currentProfile,
                    name: store.form.name,
                    dose: store.form.dose,
                    date: now.toISOString().split('T')[0],
                    time: time,
                    taken_at: time,
                    med_id: null
                };

                try {
                    const { data, error } = await _db.from('logs').insert(logData).select();
                    if(error) throw error;
                    store.logs.push(data[0]);
                    store.modal = false;
                } catch(e) { console.error(e); alert("Error guardando"); } finally { setBusy(false); render(); }
            },

            deleteMed: async () => {
                if(!confirm('¬øEliminar?')) return;
                setBusy(true);
                await _db.from('medications').delete().eq('id', store.editId);
                store.meds = store.meds.filter(m => m.id !== store.editId);
                store.modal = false;
                setBusy(false); render();
            },

            openModal: (type = 'regular', id = null) => {
                store.modalType = type;
                store.editId = id;
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                const timeStr = today.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                if (type === 'regular') {
                    if(id) {
                        const m = store.meds.find(x => x.id === id);
                        store.form = { 
                            name: m.name, dose: m.dose, time: m.time, 
                            stock: m.stock, minStock: m.min_stock, trackStock: m.track_stock,
                            frequencyType: m.frequency_type || 'daily',
                            frequencyDays: m.frequency_days ? m.frequency_days.split(',') : [],
                            intervalDays: m.interval_days || 14,
                            startDate: m.start_date || todayStr
                        };
                    } else {
                        store.form = { name: '', dose: '', time: '08:00', stock: '', minStock: '5', trackStock: false, frequencyType: 'daily', frequencyDays: [], intervalDays: 14, startDate: todayStr };
                    }
                } else {
                    // Ocasional: Hora default = ahora
                    store.form = { name: '', dose: '', time: timeStr };
                }
                store.modal = true;
                render();
            },
            closeModal: () => { store.modal = false; render(); },
            updateForm: (field, val) => { 
                store.form[field] = val; 
                if(['trackStock', 'frequencyType'].includes(field)) render();
            },
            toggleDay: (day) => {
                const days = store.form.frequencyDays;
                if(days.includes(day)) store.form.frequencyDays = days.filter(d => d !== day);
                else store.form.frequencyDays.push(day);
                render();
            },
            
            addToCalendar: (medId) => {
                const med = store.meds.find(m => m.id === medId);
                if (!med) return;
                const profile = store.profiles.find(p => p.id === med.profile_id);
                const now = new Date();
                const [hours, minutes] = med.time.split(':');
                const startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);
                const endDate = new Date(startDate.getTime() + 10 * 60000);
                const formatDate = (date) => date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                const title = encodeURIComponent(`üíä ${med.name} (${profile.name})`);
                const details = encodeURIComponent(`Dosis: ${med.dose}`);
                const dates = `${formatDate(startDate)}/${formatDate(endDate)}`;
                let recur = 'RRULE:FREQ=DAILY';
                if (med.frequency_type === 'specific_days') {
                    const map = { '1':'MO', '2':'TU', '3':'WE', '4':'TH', '5':'FR', '6':'SA', '0':'SU' };
                    const days = med.frequency_days.split(',').map(d => map[d]).join(',');
                    recur = `RRULE:FREQ=WEEKLY;BYDAY=${days}`;
                } else if (med.frequency_type === 'interval') {
                    recur = `RRULE:FREQ=DAILY;INTERVAL=${med.interval_days}`;
                }
                const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&details=${details}&dates=${dates}&recur=${recur}`;
                window.open(url, '_blank');
            }
        };

        function render() {
            const p = store.profiles.find(x => x.id === store.currentProfile);
            const meds = store.meds.filter(m => m.profile_id === store.currentProfile);
            const today = new Date().toISOString().split('T')[0];

            document.getElementById('header-container').innerHTML = `
                <div class="bg-white border-b border-gray-100 shadow-sm pt-safe">
                    <div class="max-w-md mx-auto px-4 py-3 flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <div class="bg-gradient-to-br from-blue-600 to-blue-700 p-2 rounded-xl text-white shadow-lg shadow-blue-200">${I.Pill}</div>
                            <div><h1 class="text-lg font-bold leading-none text-gray-800">Pastillero</h1><p class="text-xs text-gray-500">Cloud Pro</p></div>
                        </div>
                        <div class="w-9 h-9 rounded-full ${p.color} text-white flex items-center justify-center font-bold shadow border-2 border-white">${p.name[0]}</div>
                    </div>
                    <div class="max-w-md mx-auto px-4 pb-3 flex gap-2 overflow-x-auto no-scrollbar">
                        ${store.profiles.map(prof => `<button onclick="Actions.setProfile(${prof.id})" class="flex-1 py-2.5 px-4 rounded-xl text-sm font-bold whitespace-nowrap transition-all ${store.currentProfile === prof.id ? `${prof.color} text-white shadow-md scale-[1.02]` : 'bg-gray-100 text-gray-500'}">${prof.name}</button>`).join('')}
                    </div>
                </div>`;

            let content = '';

            if (store.view === 'home') {
                const scheduledList = meds.filter(m => isScheduledForToday(m));
                const list = scheduledList.map(m => ({ ...m, isTaken: store.logs.some(l => l.med_id === m.id && l.date === today && l.time === m.time) })).sort((a,b) => a.time.localeCompare(b.time));
                const progress = list.length ? Math.round((list.filter(x => x.isTaken).length / list.length) * 100) : 0;
                const alerts = meds.filter(m => m.track_stock && (m.stock <= m.min_stock));

                content = `
                    <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 mb-5">
                        <div class="flex justify-between items-end mb-3">
                            <div><p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Hoy</p><h2 class="text-3xl font-bold text-gray-800">${progress}%</h2></div>
                            <div class="text-xs font-bold bg-gray-50 px-3 py-1.5 rounded-lg text-gray-600 border border-gray-100">${list.filter(x => x.isTaken).length}/${list.length} Dosis</div>
                        </div>
                        <div class="h-3 bg-gray-100 rounded-full overflow-hidden"><div class="h-full transition-all duration-500 ${p.color}" style="width: ${progress}%"></div></div>
                    </div>
                    ${alerts.length ? `<div class="bg-orange-50 border-l-4 border-orange-400 p-3 rounded-r-xl flex gap-3 mb-4 shadow-sm animate-fade-in"><span class="text-orange-500 mt-0.5">${I.Alert}</span><div><p class="font-bold text-sm text-orange-800">Reponer Stock</p>${alerts.map(a => `<p class="text-xs text-orange-700 mt-0.5">‚Ä¢ ${a.name}: Quedan ${a.stock}</p>`).join('')}</div></div>` : ''}
                    
                    <div class="flex gap-2 mb-4">
                        <button onclick="Actions.openModal('regular')" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-md active:scale-95 transition-all flex items-center justify-center gap-2 text-sm">${I.Plus} Agendar</button>
                        <button onclick="Actions.openModal('occasional')" class="flex-1 py-3 bg-purple-100 text-purple-700 rounded-xl font-bold shadow-sm active:scale-95 transition-all flex items-center justify-center gap-2 text-sm">${I.Plus} Ocasional</button>
                    </div>

                    <h3 class="font-bold text-gray-700 text-lg mb-3 px-1">Agenda</h3>
                    <div class="space-y-3">
                        ${list.length === 0 ? `<div class="text-center py-12 opacity-40"><div class="w-16 h-16 bg-gray-200 rounded-full mx-auto mb-3 flex items-center justify-center text-gray-400">${I.Pill}</div><p>Nada programado</p></div>` : list.map(m => `
                            <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col gap-3 transition-all ${m.isTaken ? 'opacity-60 bg-gray-50/50' : ''}">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-4 flex-1 cursor-pointer" onclick="Actions.openModal('regular', ${m.id})">
                                        <div class="w-12 h-12 rounded-xl flex items-center justify-center shrink-0 ${m.isTaken ? 'bg-green-100 text-green-600' : `${p.light} ${p.text}`}">${I.Pill}</div>
                                        <div><p class="font-bold text-gray-800 text-lg leading-tight">${m.name}</p><p class="text-sm text-gray-500 mt-0.5 font-medium">${m.dose}</p></div>
                                    </div>
                                    <button onclick="Actions.toggleTaken(${m.id})" class="w-12 h-12 rounded-full border-2 flex items-center justify-center shrink-0 transition-all ${m.isTaken ? 'bg-green-500 border-green-500 text-white shadow-md scale-105' : 'border-gray-200 text-gray-300 active:border-blue-300'}">${m.isTaken ? I.Check : ''}</button>
                                </div>
                                <div class="border-t border-gray-100 pt-2 mt-1 flex justify-between items-center">
                                    <div class="flex items-center gap-1 text-xs text-gray-500 font-bold bg-gray-50 px-2 py-1 rounded-lg">${I.Clock} ${m.time}</div>
                                    <button onclick="Actions.addToCalendar(${m.id})" class="text-xs font-bold text-blue-600 flex items-center gap-1 px-2 py-1 rounded-lg hover:bg-blue-50 active:bg-blue-100 transition-colors">${I.Calendar} Alarma</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>`;

            } else if (store.view === 'history') {
                const history = store.logs.filter(l => l.profile_id === store.currentProfile).sort((a, b) => new Date(b.date + 'T' + b.time) - new Date(a.date + 'T' + a.time));
                const grouped = {}; history.forEach(l => { if (!grouped[l.date]) grouped[l.date] = []; grouped[l.date].push(l); });
                content = `<h2 class="font-bold text-xl text-gray-800 mb-4 px-1">Historial</h2>`;
                if (history.length === 0) content += `<div class="text-center py-12 opacity-40"><p>No hay registros</p></div>`;
                else {
                    content += `<div class="space-y-6">`;
                    Object.keys(grouped).sort().reverse().forEach(date => {
                        const dateStr = new Date(date + 'T00:00:00').toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                        content += `<div><h3 class="text-xs font-bold uppercase text-gray-400 mb-3 ml-1 sticky top-0 bg-gray-50 py-2 backdrop-blur-sm bg-opacity-90">${date === today ? 'Hoy' : dateStr}</h3><div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">${grouped[date].map((log, idx) => `
                            <div class="p-4 flex justify-between items-center ${idx !== grouped[date].length - 1 ? 'border-b border-gray-50' : ''}">
                                <div class="flex items-center gap-3">
                                    <div class="${log.med_id ? 'bg-green-50 text-green-600' : 'bg-purple-50 text-purple-600'} p-1.5 rounded-lg scale-90">${log.med_id ? I.Check : I.Zap}</div>
                                    <div><p class="font-bold text-gray-800">${log.name}</p><p class="text-xs text-gray-500">${log.dose}</p></div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <div class="text-right"><p class="font-bold text-gray-600 text-sm">${log.taken_at || log.time}</p><p class="text-[10px] text-gray-400">${log.med_id ? 'Prog: '+log.time : 'Ocasional'}</p></div>
                                    <button onclick="Actions.deleteLog(${log.id})" class="text-gray-300 hover:text-red-500 p-2">${I.Trash}</button>
                                </div>
                            </div>
                        `).join('')}</div></div>`;
                    });
                    content += `</div>`;
                }

            } else if (store.view === 'stock') {
                content = `<h2 class="font-bold text-xl text-gray-800 mb-4 px-1">Stock</h2><div class="grid grid-cols-2 gap-3">${meds.filter(m => m.track_stock).map(m => `
                    <div class="bg-white border border-gray-100 p-4 rounded-2xl shadow-sm relative flex flex-col justify-between h-40">
                        <div onclick="Actions.openModal('regular', ${m.id})" class="absolute top-0 right-0 p-3 text-gray-300 hover:text-blue-500 cursor-pointer active:scale-90 transition-transform">${I.Edit}</div>
                        <div class="mt-2"><h3 class="font-bold text-gray-800 truncate pr-6">${m.name}</h3><div class="mt-1 flex items-end gap-1"><span class="text-4xl font-bold ${m.stock <= m.min_stock ? 'text-red-500' : 'text-gray-700'}">${m.stock}</span><span class="text-xs text-gray-500 mb-1 font-medium">unid.</span></div></div>
                        <div class="flex gap-2 mt-2"><button onclick="Actions.updateStock(${m.id}, -1)" class="flex-1 bg-red-50 text-red-600 rounded-xl font-bold text-xl py-2 active:bg-red-100 transition-colors">-</button><button onclick="Actions.updateStock(${m.id}, 1)" class="flex-1 bg-green-50 text-green-600 rounded-xl font-bold text-xl py-2 active:bg-green-100 transition-colors">+</button></div>
                    </div>`).join('')}</div><button onclick="Actions.openModal('regular'); Actions.updateForm('trackStock', true)" class="w-full py-4 border-2 border-dashed border-gray-300 rounded-2xl text-gray-400 font-bold flex items-center justify-center gap-2 mt-6 active:bg-gray-100 transition-colors">${I.Plus} A√±adir Stock</button>`;
            }

            document.getElementById('app-content').innerHTML = content;
            document.getElementById('nav-container').innerHTML = `<div class="max-w-md mx-auto flex justify-around items-center h-16"><button onclick="Actions.setView('home')" class="flex flex-col items-center gap-1 w-1/4 ${store.view === 'home' ? 'text-blue-600' : 'text-gray-400'}">${I.Home}<span class="text-[10px] font-bold">Hoy</span></button><button onclick="Actions.setView('history')" class="flex flex-col items-center gap-1 w-1/4 ${store.view === 'history' ? 'text-blue-600' : 'text-gray-400'}">${I.History}<span class="text-[10px] font-bold">Historial</span></button><div class="relative -top-6 w-1/4 flex justify-center"><button onclick="Actions.openModal('regular')" class="bg-blue-600 text-white w-14 h-14 rounded-full shadow-xl shadow-blue-200 flex items-center justify-center border-4 border-white transform active:scale-95 transition-transform">${I.Plus}</button></div><button onclick="Actions.setView('stock')" class="flex flex-col items-center gap-1 w-1/4 ${store.view === 'stock' ? 'text-blue-600' : 'text-gray-400'}">${I.Stock}<span class="text-[10px] font-bold">Stock</span></button></div>`;

            // RENDER MODAL
            if (store.modal) {
                let modalContent = '';
                
                if (store.modalType === 'regular') {
                    modalContent = `
                        <div class="space-y-5">
                            <div><label class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1.5 block">Nombre</label><input type="text" value="${store.form.name}" oninput="Actions.updateForm('name', this.value)" class="w-full p-4 bg-gray-50 rounded-xl font-bold text-lg border border-gray-200 outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="Ej: Ibuprofeno"></div>
                            <div class="flex gap-4">
                                <div class="flex-1"><label class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1.5 block">Dosis</label><input type="text" value="${store.form.dose}" oninput="Actions.updateForm('dose', this.value)" class="w-full p-4 bg-gray-50 rounded-xl border border-gray-200 outline-none focus:ring-2 focus:ring-blue-500" placeholder="500mg"></div>
                                <div class="flex-1"><label class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1.5 block">Hora</label><input type="time" value="${store.form.time}" oninput="Actions.updateForm('time', this.value)" class="w-full p-4 bg-gray-50 rounded-xl border border-gray-200 outline-none focus:ring-2 focus:ring-blue-500"></div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-2xl border border-gray-200">
                                <label class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 block">Frecuencia</label>
                                <select onchange="Actions.updateForm('frequencyType', this.value)" class="w-full p-3 bg-white border border-gray-200 rounded-xl mb-3">
                                    <option value="daily" ${store.form.frequencyType === 'daily' ? 'selected' : ''}>Todos los d√≠as</option>
                                    <option value="specific_days" ${store.form.frequencyType === 'specific_days' ? 'selected' : ''}>D√≠as espec√≠ficos</option>
                                    <option value="interval" ${store.form.frequencyType === 'interval' ? 'selected' : ''}>Intervalo</option>
                                </select>
                                ${store.form.frequencyType === 'specific_days' ? `<div class="flex justify-between gap-1 mb-2">${['L','M','M','J','V','S','D'].map((d, i) => { const val = (i + 1) % 7; const selected = store.form.frequencyDays.includes(val.toString()); return `<button onclick="Actions.toggleDay('${val}')" class="day-btn w-9 h-9 rounded-full text-xs font-bold border ${selected ? 'selected' : 'bg-white border-gray-200 text-gray-500'}">${d}</button>` }).join('')}</div>` : ''}
                                ${store.form.frequencyType === 'interval' ? `<div class="flex gap-3"><div class="flex-1"><label class="text-xs text-gray-500 mb-1 block">Cada (d√≠as)</label><input type="number" value="${store.form.intervalDays}" oninput="Actions.updateForm('intervalDays', this.value)" class="w-full p-3 bg-white border border-gray-200 rounded-xl"></div><div class="flex-1"><label class="text-xs text-gray-500 mb-1 block">Inicio</label><input type="date" value="${store.form.startDate}" oninput="Actions.updateForm('startDate', this.value)" class="w-full p-3 bg-white border border-gray-200 rounded-xl"></div></div>` : ''}
                            </div>
                            <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                                <label class="flex items-center gap-3 text-sm font-bold text-blue-800 mb-2 cursor-pointer select-none py-1"><input type="checkbox" ${store.form.trackStock ? 'checked' : ''} onchange="Actions.updateForm('trackStock', this.checked)" class="w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500"> Controlar Stock</label>
                                ${store.form.trackStock ? `<div class="flex gap-3 animate-fade-in mt-3"><div class="flex-1"><label class="text-xs text-blue-600 font-semibold block mb-1">Cantidad</label><input type="number" value="${store.form.stock}" oninput="Actions.updateForm('stock', this.value)" class="w-full p-3 bg-white border border-blue-200 rounded-xl focus:outline-none focus:border-blue-500"></div><div class="flex-1"><label class="text-xs text-blue-600 font-semibold block mb-1">Avisar con</label><input type="number" value="${store.form.minStock}" oninput="Actions.updateForm('minStock', this.value)" class="w-full p-3 bg-white border border-blue-200 rounded-xl focus:outline-none focus:border-blue-500"></div></div>` : ''}
                            </div>
                            <button onclick="Actions.saveForm()" class="w-full py-4 bg-blue-600 text-white rounded-xl font-bold text-lg shadow-lg shadow-blue-200 active:bg-blue-700 active:scale-[0.98] transition-all mt-2">Guardar</button>
                            ${store.editId ? `<button onclick="Actions.deleteMed()" class="w-full py-3 text-red-500 font-bold text-sm active:bg-red-50 rounded-xl transition-all flex items-center justify-center gap-2">${I.Trash} Eliminar Medicamento</button>` : ''}
                        </div>
                    `;
                } else {
                    modalContent = `
                        <div class="space-y-5">
                            <div class="bg-purple-50 p-3 rounded-xl text-purple-800 text-sm font-medium text-center mb-2">‚ö° Registro R√°pido (Ocasional)</div>
                            <div><label class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1.5 block">Qu√© tomaste</label><input type="text" value="${store.form.name}" oninput="Actions.updateForm('name', this.value)" class="w-full p-4 bg-gray-50 rounded-xl font-bold text-lg border border-gray-200 outline-none focus:ring-2 focus:ring-purple-500 transition-all" placeholder="Ej: Paracetamol"></div>
                            <div class="flex gap-4">
                                <div class="flex-1"><label class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1.5 block">Dosis</label><input type="text" value="${store.form.dose}" oninput="Actions.updateForm('dose', this.value)" class="w-full p-4 bg-gray-50 rounded-xl border border-gray-200 outline-none focus:ring-2 focus:ring-purple-500" placeholder="500mg"></div>
                                <div class="flex-1"><label class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1.5 block">Hora</label><input type="time" value="${store.form.time}" oninput="Actions.updateForm('time', this.value)" class="w-full p-4 bg-gray-50 rounded-xl border border-gray-200 outline-none focus:ring-2 focus:ring-purple-500"></div>
                            </div>
                            <button onclick="Actions.saveOccasional()" class="w-full py-4 bg-purple-600 text-white rounded-xl font-bold text-lg shadow-lg shadow-purple-200 active:bg-purple-700 active:scale-[0.98] transition-all mt-4">Registrar Toma</button>
                        </div>
                    `;
                }

                document.getElementById('modal-container').innerHTML = `
                    <div class="fixed inset-0 bg-black/60 z-50 flex items-end sm:items-center justify-center p-4 animate-fade-in backdrop-blur-sm">
                        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-slide-up max-h-[85vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-6"><h3 class="font-bold text-xl text-gray-800">${store.modalType === 'regular' ? (store.editId ? 'Editar' : 'Nuevo') : 'Ocasional'}</h3><button onclick="Actions.closeModal()" class="bg-gray-100 p-2 rounded-full active:bg-gray-200 text-gray-600">${I.X}</button></div>
                            ${modalContent}
                        </div>
                    </div>`;
            } else { document.getElementById('modal-container').innerHTML = ''; }
        }
        window.Actions = Actions;
        window.onload = init;
    </script>
</body>
</html>